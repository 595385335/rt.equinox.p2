/******************************************************************************* *  Copyright (c) 2009 IBM Corporation and others. *  All rights reserved. This program and the accompanying materials *  are made available under the terms of the Eclipse Public License v1.0 *  which accompanies this distribution, and is available at *  http://www.eclipse.org/legal/epl-v10.html *  *  Contributors: *      IBM Corporation - initial API and implementation *******************************************************************************/package org.eclipse.equinox.p2.tests.planner;import java.io.File;import java.lang.reflect.Field;import java.net.MalformedURLException;import java.net.URL;import java.util.Iterator;import org.eclipse.core.runtime.IStatus;import org.eclipse.core.runtime.NullProgressMonitor;import org.eclipse.equinox.internal.p2.core.helpers.ServiceHelper;import org.eclipse.equinox.internal.p2.engine.SimpleProfileRegistry;import org.eclipse.equinox.internal.provisional.p2.core.ProvisionException;import org.eclipse.equinox.internal.provisional.p2.director.*;import org.eclipse.equinox.internal.provisional.p2.engine.*;import org.eclipse.equinox.internal.provisional.p2.metadata.IInstallableUnit;import org.eclipse.equinox.internal.provisional.p2.metadata.query.InstallableUnitQuery;import org.eclipse.equinox.internal.provisional.p2.metadata.repository.IMetadataRepository;import org.eclipse.equinox.internal.provisional.p2.metadata.repository.IMetadataRepositoryManager;import org.eclipse.equinox.internal.provisional.p2.query.Collector;import org.eclipse.equinox.p2.tests.AbstractProvisioningTest;import org.eclipse.equinox.p2.tests.TestActivator;public class Bug300104bis extends AbstractProvisioningTest {	private IProfile profile;	private File previousStoreValue = null;	String profileLoadedId = "bootProfile";	IMetadataRepository repo = null;	protected void setUp() throws Exception {		super.setUp();		File reporegistry1 = getTestData("test data bug 300104bis", "testData/bug300104bis/");		File tempFolder = getTempFolder();		copy("0.2", reporegistry1, tempFolder);		SimpleProfileRegistry realProfileRegistry = getProfileRegistry();		//Tweak the running profile registry		Field profileStore = SimpleProfileRegistry.class.getDeclaredField("store");		profileStore.setAccessible(true);		previousStoreValue = (File) profileStore.get(realProfileRegistry);		profileStore.set(realProfileRegistry, new File(tempFolder, "p2/org.eclipse.equinox.p2.engine/profileRegistry"));		Field profilesMapField = SimpleProfileRegistry.class.getDeclaredField("profiles"); //$NON-NLS-1$		profilesMapField.setAccessible(true);		profilesMapField.set(realProfileRegistry, null);		//End of tweaking the profile registry		profile = realProfileRegistry.getProfile(profileLoadedId);		assertNotNull(profile);		repo = loadMetadataRepository(getTestData("Repository for 300104bis", "testData/bug300104bis/repo").toURL());	}	private SimpleProfileRegistry getProfileRegistry() {		return (SimpleProfileRegistry) ServiceHelper.getService(TestActivator.getContext(), IProfileRegistry.class.getName());	}	protected IMetadataRepository loadMetadataRepository(URL location) throws ProvisionException {		IMetadataRepositoryManager metadataRepositoryManager = getMetadataRepositoryManager();		return metadataRepositoryManager.loadRepository(location, null);	}	protected void tearDown() throws Exception {		SimpleProfileRegistry realProfileRegistry = (SimpleProfileRegistry) getProfileRegistry();		Field profilesMapField = SimpleProfileRegistry.class.getDeclaredField("profiles"); //$NON-NLS-1$		profilesMapField.setAccessible(true);		profilesMapField.set(realProfileRegistry, null);		Field profileStore = SimpleProfileRegistry.class.getDeclaredField("store");		profileStore.setAccessible(true);		profileStore.set(realProfileRegistry, previousStoreValue);		super.tearDown();	}	public void testInstall() throws MalformedURLException {		IMetadataRepositoryManager mgr = getMetadataRepositoryManager();		URL repoURL = getTestData("test data bug 300104bis repo", "testData/bug300104bis/repo").toURL();		URL repo2URL = getTestData("test data bug 300104bis repo", "testData/bug300104bis/repo1").toURL();		try {			repo = loadMetadataRepository(repoURL);			loadMetadataRepository(repo2URL);		} catch (ProvisionException e) {			assertNull(e); //This guarantees that the error does not go unnoticed		}		Collector ius = repo.query(InstallableUnitQuery.ANY, new Collector(), new NullProgressMonitor());		IPlanner planner = createPlanner();		ProvisioningContext context = new ProvisioningContext(new URL[] {repoURL, repo2URL});		ProvisioningPlan plan = planner.getProvisioningPlan(createRequest(ius), context, new NullProgressMonitor());		IStatus s = createEngine().perform(profile, new DefaultPhaseSet(), plan.getOperands(), null, new NullProgressMonitor());		assertOK("engine failed", s);		ProvisioningPlan plan2 = planner.getProvisioningPlan(createRequest(ius), context, new NullProgressMonitor());		IStatus s2 = createEngine().perform(profile, new DefaultPhaseSet(), plan.getOperands(), null, new NullProgressMonitor());		assertOK("second engine operation failed", s2);		ProvisioningPlan plan3 = planner.getProvisioningPlan(createRequest(ius), context, new NullProgressMonitor());		//		assertNotIUs(ius.toArray(IInstallableUnit.class), p)		//		assertTrue(plan2.getAdditions().query(InstallableUnitQuery.ANY, new NullProgressMonitor()).isEmpty());		//		assertTrue(plan2.getRemovals().query(InstallableUnitQuery.ANY, new NullProgressMonitor()).isEmpty());		System.out.println(plan3);	}	private ProfileChangeRequest createRequest(Collector ius) {		ProfileChangeRequest pcr = new ProfileChangeRequest(profile);		pcr.addInstallableUnits((IInstallableUnit[]) ius.toArray(IInstallableUnit.class));		Iterator it = ius.iterator();		while (it.hasNext()) {			IInstallableUnit iu = (IInstallableUnit) it.next();			pcr.setInstallableUnitInclusionRules(iu, PlannerHelper.createOptionalInclusionRule(iu));		}		return pcr;	}}